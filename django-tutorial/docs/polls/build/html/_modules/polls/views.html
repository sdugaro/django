
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>polls.views &#8212; Django Polls 0.1 documentation</title>
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pyramid.css" type="text/css" />
    <script id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/language_data.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Neuton&amp;subset=latin" type="text/css" media="screen" charset="utf-8" />
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Nobile:regular,italic,bold,bolditalic&amp;subset=latin" type="text/css" media="screen" charset="utf-8" />
<!--[if lte IE 6]>
<link rel="stylesheet" href="../../_static/ie6.css" type="text/css" media="screen" charset="utf-8" />
<![endif]-->

  </head><body>

    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">Django Polls 0.1 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" accesskey="U">Module code</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">polls.views</a></li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for polls.views</h1><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">django.http</span> <span class="kn">import</span> <span class="n">HttpResponse</span>
<span class="kn">from</span> <span class="nn">django.http</span> <span class="kn">import</span> <span class="n">HttpResponseRedirect</span>
<span class="kn">from</span> <span class="nn">django.shortcuts</span> <span class="kn">import</span> <span class="n">get_object_or_404</span><span class="p">,</span> <span class="n">render</span><span class="p">,</span> <span class="n">redirect</span>
<span class="kn">from</span> <span class="nn">django.urls</span> <span class="kn">import</span> <span class="n">reverse</span><span class="p">,</span> <span class="n">reverse_lazy</span>
<span class="kn">from</span> <span class="nn">django.views</span> <span class="kn">import</span> <span class="n">generic</span>
<span class="kn">from</span> <span class="nn">django.utils</span> <span class="kn">import</span> <span class="n">timezone</span>
<span class="c1">#from django.contrib.auth.forms import UserCreationForm</span>
<span class="kn">from</span> <span class="nn">django.contrib</span> <span class="kn">import</span> <span class="n">messages</span>
<span class="kn">from</span> <span class="nn">django.contrib.messages.views</span> <span class="kn">import</span> <span class="n">SuccessMessageMixin</span>
<span class="kn">from</span> <span class="nn">django.template.loader</span> <span class="kn">import</span> <span class="n">render_to_string</span>
<span class="kn">from</span> <span class="nn">django.core.mail</span> <span class="kn">import</span> <span class="n">EmailMessage</span>
<span class="kn">from</span> <span class="nn">django.core.paginator</span> <span class="kn">import</span> <span class="n">Paginator</span>
<span class="kn">from</span> <span class="nn">django.conf</span> <span class="kn">import</span> <span class="n">settings</span>

<span class="kn">from</span> <span class="nn">django.http</span> <span class="kn">import</span> <span class="n">FileResponse</span><span class="p">,</span> <span class="n">Http404</span>
<span class="kn">from</span> <span class="nn">django.template.loader</span> <span class="kn">import</span> <span class="n">get_template</span>
<span class="kn">from</span> <span class="nn">xhtml2pdf</span> <span class="kn">import</span> <span class="n">pisa</span>

<span class="kn">from</span> <span class="nn">.models</span> <span class="kn">import</span> <span class="n">Question</span><span class="p">,</span> <span class="n">Choice</span>
<span class="kn">from</span> <span class="nn">.logger</span> <span class="kn">import</span> <span class="n">POLLS_BOTH</span> <span class="k">as</span> <span class="n">logger</span>
<span class="kn">from</span> <span class="nn">.signals</span> <span class="kn">import</span> <span class="n">pdf_done</span>
<span class="kn">from</span> <span class="nn">.forms</span> <span class="kn">import</span> <span class="n">SignUpForm</span>
<span class="kn">from</span> <span class="nn">.apps</span> <span class="kn">import</span> <span class="n">PollsConfig</span>


<span class="c1">#</span>
<span class="c1"># Custom Paginator for Long Paginations</span>
<span class="c1"># ---------------------------------------</span>

<div class="viewcode-block" id="BootstrapPaginator"><a class="viewcode-back" href="../../modules/views.html#polls.views.BootstrapPaginator">[docs]</a><span class="k">class</span> <span class="nc">BootstrapPaginator</span><span class="p">(</span><span class="n">Paginator</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A paginator that does not return the entire range, rather</span>
<span class="sd">    a few wing pages on either side of the current page.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initialize Paginator parameters, defaulting extended parameters</span>

<span class="sd">        Args:</span>
<span class="sd">            wing_pages (int): default 2</span>
<span class="sd">                the number of pages shown before and after the current page.</span>
<span class="sd">            max_pages (int): defaut 5</span>
<span class="sd">                the total number of pages to show in the pagination range</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_pages</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;max_pages&#39;</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wing_pages</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;wing_pages&#39;</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
        <span class="c1">#super(BootstrapPaginator, self).__init__(*args, **kwargs)  # Py2k</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>  <span class="c1"># Py3k</span>

    <span class="k">def</span> <span class="nf">_get_page</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">page</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">BootstrapPaginator</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">_get_page</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">page</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">page_range</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">fold_min</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">page</span><span class="o">.</span><span class="n">number</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">wing_pages</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">fold_max</span> <span class="o">=</span> <span class="n">fold_min</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_pages</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;fold_min[</span><span class="si">{</span><span class="n">fold_min</span><span class="si">}</span><span class="s2">] fold_max[</span><span class="si">{</span><span class="n">fold_max</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">fold_max</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_pages</span><span class="p">:</span>
            <span class="n">fold_min</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_pages</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_pages</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="n">fold_max</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_pages</span> <span class="o">+</span> <span class="mi">1</span>

        <span class="n">fold_range</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="n">fold_min</span><span class="p">,</span> <span class="n">fold_max</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;fold_range=</span><span class="si">{</span><span class="n">fold_range</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">fold_range</span></div>


<span class="c1"># Generic Class Based Views</span>
<span class="c1"># ---------------------------</span>
<div class="viewcode-block" id="HomeView"><a class="viewcode-back" href="../../modules/views.html#polls.views.HomeView">[docs]</a><span class="k">class</span> <span class="nc">HomeView</span><span class="p">(</span><span class="n">generic</span><span class="o">.</span><span class="n">ListView</span><span class="p">):</span>
    <span class="c1">#template_name = &#39;polls/home.html&#39;</span>
    <span class="n">template_name</span> <span class="o">=</span> <span class="s1">&#39;polls/home_bootstrap.html&#39;</span>
    <span class="n">context_object_name</span> <span class="o">=</span> <span class="s1">&#39;latest_question_list&#39;</span>
    <span class="n">paginate_by</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">paginator_class</span> <span class="o">=</span> <span class="n">BootstrapPaginator</span>

<div class="viewcode-block" id="HomeView.get_queryset"><a class="viewcode-back" href="../../modules/views.html#polls.views.HomeView.get_queryset">[docs]</a>    <span class="k">def</span> <span class="nf">get_queryset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the last five published questions.</span>
<span class="sd">        Do not including those set to be published in the future:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1">#return Question.objects.order_by(&#39;-pub_date&#39;)[:5]</span>

        <span class="c1"># filter timezones less than now</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">Question</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">pub_date__lte</span><span class="o">=</span><span class="n">timezone</span><span class="o">.</span><span class="n">now</span><span class="p">())</span>
        <span class="c1">#result = result.order_by(&#39;-pub_date&#39;)[:5]</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s1">&#39;-pub_date&#39;</span><span class="p">)</span>

        <span class="n">objects</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">result</span><span class="p">])</span>
        <span class="c1">#logger.debug(&quot;\n{}&quot;.format(&#39;\n&#39;.join([str(x) for x in result])))</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Ordered [</span><span class="si">{</span><span class="n">result</span><span class="o">.</span><span class="n">count</span><span class="p">()</span><span class="si">}</span><span class="s2">] Questions by reverse pub_date&quot;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="si">{</span><span class="n">objects</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">done</span><span class="p">(</span><span class="s2">&quot;get_queryset()&quot;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Test&quot;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="s2">&quot;Boom!&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">result</span></div></div>


<div class="viewcode-block" id="DetailView"><a class="viewcode-back" href="../../modules/views.html#polls.views.DetailView">[docs]</a><span class="k">class</span> <span class="nc">DetailView</span><span class="p">(</span><span class="n">generic</span><span class="o">.</span><span class="n">DetailView</span><span class="p">):</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">Question</span>
    <span class="c1">#template_name = &#39;polls/detail.html&#39;</span>
    <span class="n">template_name</span> <span class="o">=</span> <span class="s1">&#39;polls/detail_bootstrap.html&#39;</span>

<div class="viewcode-block" id="DetailView.get_context_data"><a class="viewcode-back" href="../../modules/views.html#polls.views.DetailView.get_context_data">[docs]</a>    <span class="k">def</span> <span class="nf">get_context_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="c1"># get context from base implementation</span>
        <span class="n">context</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">get_context_data</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">context</span><span class="p">[</span><span class="s1">&#39;extra&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;data&quot;</span>
        <span class="k">return</span> <span class="n">context</span></div></div>


<div class="viewcode-block" id="ResultsView"><a class="viewcode-back" href="../../modules/views.html#polls.views.ResultsView">[docs]</a><span class="k">class</span> <span class="nc">ResultsView</span><span class="p">(</span><span class="n">generic</span><span class="o">.</span><span class="n">DetailView</span><span class="p">):</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">Question</span>
    <span class="c1">#template_name = &#39;polls/results.html&#39;</span>
    <span class="n">template_name</span> <span class="o">=</span> <span class="s1">&#39;polls/results_bootstrap.html&#39;</span>

<div class="viewcode-block" id="ResultsView.get_object"><a class="viewcode-back" href="../../modules/views.html#polls.views.ResultsView.get_object">[docs]</a>    <span class="k">def</span> <span class="nf">get_object</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># run logic before base class calls get_object</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;About to get_object results&quot;</span><span class="p">)</span>
        <span class="n">obj</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">get_object</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;got </span><span class="si">{</span><span class="n">obj</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">obj</span></div></div>


<div class="viewcode-block" id="SignUpView"><a class="viewcode-back" href="../../modules/views.html#polls.views.SignUpView">[docs]</a><span class="k">class</span> <span class="nc">SignUpView</span><span class="p">(</span><span class="n">SuccessMessageMixin</span><span class="p">,</span> <span class="n">generic</span><span class="o">.</span><span class="n">CreateView</span><span class="p">):</span>
    <span class="c1">#form_class = UserCreationForm</span>
    <span class="n">form_class</span> <span class="o">=</span> <span class="n">SignUpForm</span>
    <span class="n">success_url</span> <span class="o">=</span> <span class="n">reverse_lazy</span><span class="p">(</span><span class="s1">&#39;polls:login&#39;</span><span class="p">)</span>
    <span class="n">template_name</span> <span class="o">=</span> <span class="s1">&#39;registration/signup.html&#39;</span>
    <span class="c1">#success_message = &quot;Account successfully created!&quot;</span>

<div class="viewcode-block" id="SignUpView.dispatch"><a class="viewcode-back" href="../../modules/views.html#polls.views.SignUpView.dispatch">[docs]</a>    <span class="k">def</span> <span class="nf">dispatch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">is_authenticated</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;polls:home&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

<div class="viewcode-block" id="SignUpView.form_valid"><a class="viewcode-back" href="../../modules/views.html#polls.views.SignUpView.form_valid">[docs]</a>    <span class="k">def</span> <span class="nf">form_valid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">form</span><span class="p">):</span>
        <span class="n">response</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">form_valid</span><span class="p">(</span><span class="n">form</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">response</span><span class="p">))</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;--&gt; New user registered. Now send email.&quot;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">)</span>

        <span class="c1"># at this point, the User should be saved in the DB,</span>
        <span class="c1"># but rather than query the DB, we can get what we need</span>
        <span class="c1"># from the form just as the DB did</span>
        <span class="n">user</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;username&#39;</span><span class="p">]</span>
        <span class="n">email</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;email&#39;</span><span class="p">]</span>

        <span class="n">context</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;appurl&#39;</span><span class="p">:</span> <span class="n">response</span><span class="o">.</span><span class="n">url</span><span class="p">,</span>
            <span class="s1">&#39;appname&#39;</span><span class="p">:</span> <span class="n">PollsConfig</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
            <span class="s1">&#39;appmail&#39;</span><span class="p">:</span> <span class="n">PollsConfig</span><span class="o">.</span><span class="n">email</span><span class="p">,</span>
            <span class="s1">&#39;siteurl&#39;</span><span class="p">:</span> <span class="n">settings</span><span class="o">.</span><span class="n">SITE_URL</span><span class="p">,</span>
            <span class="s1">&#39;sitemail&#39;</span><span class="p">:</span> <span class="n">settings</span><span class="o">.</span><span class="n">DEFAULT_FROM_EMAIL</span><span class="p">,</span>
            <span class="s1">&#39;sitename&#39;</span><span class="p">:</span> <span class="n">settings</span><span class="o">.</span><span class="n">SITE_NAME</span><span class="p">,</span>
            <span class="s1">&#39;username&#39;</span><span class="p">:</span> <span class="n">user</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="n">subject</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Welcome to </span><span class="si">{</span><span class="n">context</span><span class="p">[</span><span class="s1">&#39;appname&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">body</span> <span class="o">=</span> <span class="n">render_to_string</span><span class="p">(</span><span class="s2">&quot;registration/welcome_email.html&quot;</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
        <span class="n">email</span> <span class="o">=</span> <span class="n">EmailMessage</span><span class="p">(</span><span class="n">subject</span><span class="p">,</span> <span class="n">body</span><span class="p">,</span> <span class="n">context</span><span class="p">[</span><span class="s1">&#39;sitemail&#39;</span><span class="p">],</span> <span class="p">[</span><span class="n">email</span><span class="p">])</span>
        <span class="n">email</span><span class="o">.</span><span class="n">content_subtype</span> <span class="o">=</span> <span class="s2">&quot;html&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">email</span><span class="o">.</span><span class="n">send</span><span class="p">()</span>
            <span class="n">message</span> <span class="o">=</span> <span class="s2">&quot;Account created! Check your email for more info.&quot;</span>
            <span class="n">messages</span><span class="o">.</span><span class="n">success</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">,</span> <span class="n">message</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="n">message</span> <span class="o">=</span> <span class="s2">&quot;Account created, but email failed.&quot;</span>
            <span class="n">messages</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">,</span> <span class="n">message</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">response</span></div></div>


<div class="viewcode-block" id="PdfListView"><a class="viewcode-back" href="../../modules/views.html#polls.views.PdfListView">[docs]</a><span class="k">class</span> <span class="nc">PdfListView</span><span class="p">(</span><span class="n">generic</span><span class="o">.</span><span class="n">ListView</span><span class="p">):</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">Question</span>
    <span class="n">template_name</span> <span class="o">=</span> <span class="s1">&#39;polls/pdf_list.html&#39;</span></div>


<div class="viewcode-block" id="PdfDetailView"><a class="viewcode-back" href="../../modules/views.html#polls.views.PdfDetailView">[docs]</a><span class="k">class</span> <span class="nc">PdfDetailView</span><span class="p">(</span><span class="n">generic</span><span class="o">.</span><span class="n">DetailView</span><span class="p">):</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">Question</span>
    <span class="n">template_name</span> <span class="o">=</span> <span class="s1">&#39;polls/pdf_detail.html&#39;</span>
    <span class="n">context_object_name</span> <span class="o">=</span> <span class="s1">&#39;question&#39;</span>  <span class="c1"># same by default (from Question)</span>

<div class="viewcode-block" id="PdfDetailView.get_context_data"><a class="viewcode-back" href="../../modules/views.html#polls.views.PdfDetailView.get_context_data">[docs]</a>    <span class="k">def</span> <span class="nf">get_context_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="c1"># need to recieve pk for the specific object instance to be handled</span>
        <span class="c1"># in the specified template. We can add local context vars here.</span>
        <span class="c1"># This is where we parse and process any query string modifiers</span>
        <span class="n">user</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">user</span>
        <span class="n">query_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">GET</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;-&gt; PdfDetailView|get_context_data]</span><span class="se">\n</span><span class="s2">user: </span><span class="si">{</span><span class="n">user</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;-&gt; PdfDetailView|get_context_data]</span><span class="se">\n</span><span class="s2">self.request.GET: </span><span class="si">{</span><span class="n">query_dict</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;-&gt; PdfDetailView|get_context_data]</span><span class="se">\n</span><span class="s2">self.kwargs: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;-&gt; PdfDetailView|get_context_data]</span><span class="se">\n</span><span class="s2">kwargs: </span><span class="si">{</span><span class="n">kwargs</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">context</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">get_context_data</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="n">keys</span> <span class="o">=</span> <span class="n">query_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
        <span class="n">context</span><span class="p">[</span><span class="s1">&#39;format&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;pdf&#39;</span>
        <span class="n">context</span><span class="p">[</span><span class="s1">&#39;download&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">context</span><span class="p">[</span><span class="s1">&#39;engine&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;xhtml2pdf&#39;</span>
        <span class="n">context</span><span class="p">[</span><span class="s1">&#39;user&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">user</span>

        <span class="k">if</span> <span class="s1">&#39;html&#39;</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">:</span>
            <span class="n">context</span><span class="p">[</span><span class="s1">&#39;format&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;html&#39;</span>
        <span class="k">if</span> <span class="s1">&#39;download&#39;</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">:</span>
            <span class="n">context</span><span class="p">[</span><span class="s1">&#39;download&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="s1">&#39;reportlab&#39;</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">:</span>
            <span class="n">context</span><span class="p">[</span><span class="s1">&#39;engine&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;reportlab&#39;</span>

        <span class="k">return</span> <span class="n">context</span></div>

<div class="viewcode-block" id="PdfDetailView.pdf_response_rl"><a class="viewcode-back" href="../../modules/views.html#polls.views.PdfDetailView.pdf_response_rl">[docs]</a>    <span class="k">def</span> <span class="nf">pdf_response_rl</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">question</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">download</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Use the ReportLab api and the Model Objects provided by the context</span>
<span class="sd">        dict in this views pipeline.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span> <span class="nn">reportlab.platypus</span> <span class="k">as</span> <span class="nn">RL</span>
        <span class="kn">import</span> <span class="nn">reportlab.lib.styles</span> <span class="k">as</span> <span class="nn">SL</span>
        <span class="kn">from</span> <span class="nn">io</span> <span class="kn">import</span> <span class="n">BytesIO</span>

        <span class="n">flo</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">BytesIO</span><span class="p">()</span>  <span class="c1"># create a byte buffer to hold PDF data</span>
        <span class="n">pdf</span> <span class="o">=</span> <span class="n">RL</span><span class="o">.</span><span class="n">SimpleDocTemplate</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
        <span class="n">pdf</span><span class="o">.</span><span class="n">showBoundary</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">pdf</span><span class="o">.</span><span class="n">leftMargin</span> <span class="o">=</span> <span class="n">pdf</span><span class="o">.</span><span class="n">rightMargin</span> <span class="o">=</span> <span class="n">pdf</span><span class="o">.</span><span class="n">leftMargin</span> <span class="o">/</span> <span class="mi">2</span>
        <span class="n">pdf</span><span class="o">.</span><span class="n">topMargin</span> <span class="o">=</span> <span class="n">pdf</span><span class="o">.</span><span class="n">bottomMargin</span> <span class="o">=</span> <span class="n">pdf</span><span class="o">.</span><span class="n">topMargin</span> <span class="o">/</span> <span class="mi">2</span>

        <span class="n">ss</span> <span class="o">=</span> <span class="n">SL</span><span class="o">.</span><span class="n">getSampleStyleSheet</span><span class="p">()</span>
        <span class="n">h1</span> <span class="o">=</span> <span class="n">RL</span><span class="o">.</span><span class="n">Paragraph</span><span class="p">(</span><span class="s2">&quot;Question:&quot;</span><span class="p">,</span> <span class="n">ss</span><span class="p">[</span><span class="s1">&#39;Heading1&#39;</span><span class="p">])</span>
        <span class="n">h2</span> <span class="o">=</span> <span class="n">RL</span><span class="o">.</span><span class="n">Paragraph</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">question</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">ss</span><span class="p">[</span><span class="s1">&#39;Heading2&#39;</span><span class="p">])</span>
        <span class="n">h3</span> <span class="o">=</span> <span class="n">RL</span><span class="o">.</span><span class="n">Paragraph</span><span class="p">(</span><span class="s2">&quot;Choices:&quot;</span><span class="p">,</span> <span class="n">ss</span><span class="p">[</span><span class="s1">&#39;Heading3&#39;</span><span class="p">])</span>
        <span class="n">hl</span> <span class="o">=</span> <span class="n">RL</span><span class="o">.</span><span class="n">HRFlowable</span><span class="p">(</span><span class="n">width</span><span class="o">=</span><span class="s1">&#39;100%&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">question</span><span class="o">.</span><span class="n">question_img</span><span class="p">:</span>
            <span class="n">img</span> <span class="o">=</span> <span class="n">RL</span><span class="o">.</span><span class="n">Image</span><span class="p">(</span><span class="n">question</span><span class="o">.</span><span class="n">question_img</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="mi">75</span><span class="p">,</span> <span class="n">hAlign</span><span class="o">=</span><span class="s2">&quot;LEFT&quot;</span><span class="p">)</span>
            <span class="n">flo</span> <span class="o">+=</span> <span class="p">[</span><span class="n">img</span><span class="p">,</span> <span class="n">hl</span><span class="p">]</span>

        <span class="n">flo</span> <span class="o">+=</span> <span class="p">[</span><span class="n">h1</span><span class="p">,</span> <span class="n">h2</span><span class="p">,</span> <span class="n">hl</span><span class="p">,</span> <span class="n">h3</span><span class="p">]</span>

        <span class="n">ps</span> <span class="o">=</span> <span class="p">[</span><span class="n">RL</span><span class="o">.</span><span class="n">Paragraph</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">c</span><span class="p">)</span><span class="si">}</span><span class="s2"> [</span><span class="si">{</span><span class="n">c</span><span class="o">.</span><span class="n">votes</span><span class="si">}</span><span class="s2"> votes]&quot;</span><span class="p">,</span> <span class="n">ss</span><span class="p">[</span><span class="s1">&#39;BodyText&#39;</span><span class="p">])</span>
              <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">question</span><span class="o">.</span><span class="n">choice_set</span><span class="o">.</span><span class="n">all</span><span class="p">()]</span>
        <span class="n">ul</span> <span class="o">=</span> <span class="p">[</span><span class="n">RL</span><span class="o">.</span><span class="n">ListItem</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="s1">&#39;sparkle&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">ps</span><span class="p">]</span>
        <span class="n">lf</span> <span class="o">=</span> <span class="n">RL</span><span class="o">.</span><span class="n">ListFlowable</span><span class="p">(</span><span class="n">ul</span><span class="p">,</span> <span class="n">bulletType</span><span class="o">=</span><span class="s1">&#39;bullet&#39;</span><span class="p">)</span>
        <span class="n">flo</span> <span class="o">+=</span> <span class="p">[</span><span class="n">lf</span><span class="p">]</span>

        <span class="n">flo</span> <span class="o">+=</span> <span class="p">[</span><span class="n">hl</span><span class="p">]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">pdf</span><span class="o">.</span><span class="n">build</span><span class="p">(</span><span class="n">flo</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">message</span> <span class="o">=</span> <span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unable to generate PDF from &lt;hl&gt;&lt;pre&gt;</span><span class="si">{</span><span class="n">html</span><span class="si">}</span><span class="s2">&lt;/pre&gt;&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="mi">500</span><span class="p">)</span>

        <span class="n">out</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># reset byte buffer pointer to the start</span>

        <span class="k">if</span> <span class="n">download</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">FileResponse</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">as_attachment</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="n">filename</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">FileResponse</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="n">filename</span><span class="p">)</span></div>

<div class="viewcode-block" id="PdfDetailView.pdf_response_xp"><a class="viewcode-back" href="../../modules/views.html#polls.views.PdfDetailView.pdf_response_xp">[docs]</a>    <span class="k">def</span> <span class="nf">pdf_response_xp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">html</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">download</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Use the xhtml2pdf to convert html to pdf an return</span>
<span class="sd">        it in an HttpResponse. Return an error message in the</span>
<span class="sd">        HttpResponse object if the conversion fails.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">disposition</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;filename=&quot;</span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s1">&quot;&#39;</span>
        <span class="k">if</span> <span class="n">download</span><span class="p">:</span>
            <span class="n">disposition</span> <span class="o">=</span> <span class="s1">&#39;attachment;&#39;</span> <span class="o">+</span> <span class="n">disposition</span>

        <span class="n">response</span> <span class="o">=</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="n">content_type</span><span class="o">=</span><span class="s1">&#39;application/pdf&#39;</span><span class="p">)</span>
        <span class="n">response</span><span class="p">[</span><span class="s1">&#39;Content-Disposition&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">disposition</span>

        <span class="n">pisa_status</span> <span class="o">=</span> <span class="n">pisa</span><span class="o">.</span><span class="n">CreatePDF</span><span class="p">(</span><span class="n">html</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="n">response</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">pisa_status</span><span class="o">.</span><span class="n">err</span><span class="p">:</span>
            <span class="n">message</span> <span class="o">=</span> <span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unable to generate PDF from &lt;hl&gt;&lt;pre&gt;</span><span class="si">{</span><span class="n">html</span><span class="si">}</span><span class="s2">&lt;/pre&gt;&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="mi">500</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">response</span></div>

<div class="viewcode-block" id="PdfDetailView.render_to_response"><a class="viewcode-back" href="../../modules/views.html#polls.views.PdfDetailView.render_to_response">[docs]</a>    <span class="k">def</span> <span class="nf">render_to_response</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="c1"># we expect polls/pdf/&lt;pk&gt;/?html or ?download.</span>
        <span class="c1"># ?html&amp;download is not possible becuse every</span>
        <span class="c1"># HttpRequest has one corresponding HttpResponse</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;-&gt; PdfDetailView|render_to_response]</span><span class="se">\n</span><span class="s2">context: </span><span class="si">{</span><span class="n">context</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;-&gt; PdfDetailView|render_to_response]</span><span class="se">\n</span><span class="s2">kwargs: </span><span class="si">{</span><span class="n">kwargs</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="c1">#return HttpResponse(f&quot;{context[&#39;format&#39;]}&quot;)</span>

        <span class="n">engine</span> <span class="o">=</span> <span class="n">context</span><span class="p">[</span><span class="s1">&#39;engine&#39;</span><span class="p">]</span>
        <span class="n">username</span> <span class="o">=</span> <span class="n">context</span><span class="p">[</span><span class="s1">&#39;user&#39;</span><span class="p">]</span>
        <span class="n">question</span> <span class="o">=</span> <span class="n">context</span><span class="p">[</span><span class="s1">&#39;question&#39;</span><span class="p">]</span>
        <span class="n">download</span> <span class="o">=</span> <span class="n">context</span><span class="p">[</span><span class="s1">&#39;download&#39;</span><span class="p">]</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;filename&#39;</span><span class="p">,</span> <span class="s1">&#39;report.pdf&#39;</span><span class="p">)</span>

        <span class="n">template</span> <span class="o">=</span> <span class="n">get_template</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">template_name</span><span class="p">)</span>
        <span class="n">html</span> <span class="o">=</span> <span class="n">template</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">context</span><span class="p">[</span><span class="s1">&#39;format&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;html&#39;</span><span class="p">:</span>
            <span class="n">response</span> <span class="o">=</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="n">html</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">engine</span> <span class="o">==</span> <span class="s1">&#39;reportlab&#39;</span><span class="p">:</span>
            <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pdf_response_rl</span><span class="p">(</span><span class="n">question</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">download</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pdf_response_xp</span><span class="p">(</span><span class="n">html</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">download</span><span class="p">)</span>

        <span class="c1"># signal to log pdf generation</span>
        <span class="n">pdf_done</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">,</span> <span class="n">user</span><span class="o">=</span><span class="n">username</span><span class="p">,</span>
                      <span class="n">filename</span><span class="o">=</span><span class="n">filename</span><span class="p">,</span> <span class="n">engine</span><span class="o">=</span><span class="n">engine</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">response</span></div></div>

<span class="c1">#---------------------------------------------------------------------------</span>
<span class="c1"># Function Based Views</span>
<span class="c1"># - for illustration and test. Use Class Based Views.</span>
<span class="c1">#---------------------------------------------------------------------------</span>


<div class="viewcode-block" id="vote"><a class="viewcode-back" href="../../modules/views.html#polls.views.vote">[docs]</a><span class="k">def</span> <span class="nf">vote</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">question_id</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Function based view requiring an id via url match or via</span>
<span class="sd">    context arguments in reverse redirect</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># blocking without DB query</span>
    <span class="c1">#return HttpResponse(&quot;You&#39;re voting on question %s.&quot; % question_id)</span>

    <span class="n">question</span> <span class="o">=</span> <span class="n">get_object_or_404</span><span class="p">(</span><span class="n">Question</span><span class="p">,</span> <span class="n">pk</span><span class="o">=</span><span class="n">question_id</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">selected_choice</span> <span class="o">=</span> <span class="n">question</span><span class="o">.</span><span class="n">choice_set</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">pk</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">[</span><span class="s1">&#39;choice&#39;</span><span class="p">])</span>
    <span class="k">except</span> <span class="p">(</span><span class="ne">KeyError</span><span class="p">,</span> <span class="n">Choice</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">):</span>
        <span class="c1"># message the error</span>
        <span class="n">messages</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s2">&quot;You didnt select a choice.&quot;</span><span class="p">)</span>
        <span class="c1"># Redisplay the question voting form.</span>
        <span class="k">return</span> <span class="n">HttpResponseRedirect</span><span class="p">(</span><span class="n">reverse</span><span class="p">(</span><span class="s1">&#39;polls:detail&#39;</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">question</span><span class="o">.</span><span class="n">id</span><span class="p">,)))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">selected_choice</span><span class="o">.</span><span class="n">votes</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">selected_choice</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
        <span class="n">messages</span><span class="o">.</span><span class="n">success</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s2">&quot;Vote successfully registered!&quot;</span><span class="p">)</span>
        <span class="c1"># Always return an HttpResponseRedirect after successfully dealing</span>
        <span class="c1"># with POST data. This prevents data from being posted twice if a</span>
        <span class="c1"># user hits the Back button.</span>
        <span class="k">return</span> <span class="n">HttpResponseRedirect</span><span class="p">(</span><span class="n">reverse</span><span class="p">(</span><span class="s1">&#39;polls:results&#39;</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">question</span><span class="o">.</span><span class="n">id</span><span class="p">,)))</span></div>


<span class="sd">&quot;&quot;&quot; Some callables for context dictionary values :</span>

<span class="sd"># Note that defining a static class method in python without a decorator</span>
<span class="sd"># does not allow you to call it from an instance of the class. Using a</span>
<span class="sd"># decorator is a more elegant and concise equivalent to:</span>

<span class="sd">class Calc:</span>

<span class="sd">    def add(x, y):</span>
<span class="sd">        return x + y</span>

<span class="sd">Calc.add = staticmethod(Calc.add)</span>

<span class="sd">&gt;&gt;&gt; class Calc:</span>
<span class="sd">...   def add(*args):</span>
<span class="sd">...     return sum(map(float,args))</span>
<span class="sd">...</span>
<span class="sd">&gt;&gt;&gt; Calc.add(1,2,3,&#39;4&#39;,&#39;5&#39;,&#39;6&#39;)</span>
<span class="sd">21.0</span>
<span class="sd">&gt;&gt;&gt; c = Calc()</span>
<span class="sd">&gt;&gt;&gt; c.add(1,2,3,&#39;4&#39;,&#39;5&#39;,&#39;6&#39;)</span>
<span class="sd">Traceback (most recent call last):</span>
<span class="sd">  File &quot;&lt;stdin&gt;&quot;, line 1, in &lt;module&gt;</span>
<span class="sd">  File &quot;&lt;stdin&gt;&quot;, line 3, in add</span>
<span class="sd">TypeError: float() argument must be a string or a number, not &#39;Calc&#39;</span>

<span class="sd">&gt;&gt;&gt; class Calc:</span>
<span class="sd">...   @staticmethod</span>
<span class="sd">...   def add(*args):</span>
<span class="sd">...     return sum(map(float,args))</span>
<span class="sd">...</span>
<span class="sd">&gt;&gt;&gt; c = Calc()</span>
<span class="sd">&gt;&gt;&gt; Calc.add(1,2,3,&#39;4&#39;,&#39;5&#39;,&#39;6&#39;)</span>
<span class="sd">21.0</span>
<span class="sd">&gt;&gt;&gt;</span>
<span class="sd">&quot;&quot;&quot;</span>


<div class="viewcode-block" id="Calculator"><a class="viewcode-back" href="../../modules/views.html#polls.views.Calculator">[docs]</a><span class="k">class</span> <span class="nc">Calculator</span><span class="p">:</span>
<div class="viewcode-block" id="Calculator.add"><a class="viewcode-back" href="../../modules/views.html#polls.views.Calculator.add">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">float</span><span class="p">,</span> <span class="n">args</span><span class="p">))</span></div></div>


<div class="viewcode-block" id="hello_world"><a class="viewcode-back" href="../../modules/views.html#polls.views.hello_world">[docs]</a><span class="k">def</span> <span class="nf">hello_world</span><span class="p">():</span>
    <span class="k">return</span> <span class="s2">&quot;Hello World&quot;</span></div>


<div class="viewcode-block" id="render_pdf_view"><a class="viewcode-back" href="../../modules/views.html#polls.views.render_pdf_view">[docs]</a><span class="k">def</span> <span class="nf">render_pdf_view</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Render out a pdf file from an html template that displays what</span>
<span class="sd">    the user input as a query string in their browser request.</span>

<span class="sd">    path(</span>
<span class="sd">        &#39;index/&lt;int:int_key&gt;/&lt;str:str_key&gt;/&lt;slug:slug_key&gt;/&lt;path:path_key&gt;&#39;,</span>
<span class="sd">        views.index)</span>

<span class="sd">    http://127.0.0.1:8000/polls/</span>
<span class="sd">        index/2020/hello/__Init0-9__/path/?name=steve&amp;age=25&amp;age=45</span>

<span class="sd">    Note that Django parses the query string into a &lt;QueryDict&gt; object</span>
<span class="sd">    and stores it in the HttpRequest.GET or HttpRequest.POST depending</span>
<span class="sd">    on whether the request was submitted via url or via a form button</span>

<span class="sd">    Note that the context passed to render is an empty dict by default.</span>
<span class="sd">    If a value in the dictionary is callable, the view will call it</span>
<span class="sd">    just before rendering the template.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">url</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">get_full_path</span><span class="p">()</span>
    <span class="n">query_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">GET</span><span class="p">)</span>
    <span class="n">questions</span> <span class="o">=</span> <span class="n">Question</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;--&gt; render_pdf_view()</span><span class="se">\n</span><span class="s2">args:</span><span class="se">\n</span><span class="si">{</span><span class="n">args</span><span class="si">}</span><span class="se">\n</span><span class="s2">kwargs</span><span class="se">\n</span><span class="si">{</span><span class="n">kwargs</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;request.GET&lt;QueryDict&gt;:</span><span class="se">\n</span><span class="si">{</span><span class="n">query_dict</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;questions&lt;QuerySet&gt;:</span><span class="se">\n</span><span class="si">{</span><span class="n">questions</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Define the template</span>
    <span class="n">template_name</span> <span class="o">=</span> <span class="s1">&#39;polls/pdf_test.html&#39;</span>
    <span class="c1"># Define the context we are passing to the template</span>
    <span class="n">data</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;view_local_var&#39;</span><span class="p">:</span> <span class="s1">&#39;view_local_val&#39;</span><span class="p">,</span>
        <span class="s1">&#39;view_local_var_1&#39;</span><span class="p">:</span> <span class="n">Calculator</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
        <span class="s1">&#39;view_local_var_2&#39;</span><span class="p">:</span> <span class="n">hello_world</span>  <span class="c1"># django will call this</span>
    <span class="p">}</span>
    <span class="n">data</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;view_local_var3&#39;</span><span class="p">,</span> <span class="n">Calculator</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;2&#39;</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
    <span class="n">data</span><span class="p">[</span><span class="s1">&#39;view_local_var4&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Calculator</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;1.1&#39;</span><span class="p">,</span> <span class="mf">2.2</span><span class="p">,</span> <span class="s1">&#39;3.3&#39;</span><span class="p">,</span> <span class="mf">4.4</span><span class="p">)</span>
    <span class="n">data</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">query_dict</span><span class="p">)</span>
    <span class="n">data</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="n">context</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;data&#39;</span><span class="p">:</span> <span class="n">data</span><span class="p">,</span> <span class="s1">&#39;url&#39;</span><span class="p">:</span> <span class="n">url</span><span class="p">,</span> <span class="s1">&#39;db&#39;</span><span class="p">:</span> <span class="n">questions</span><span class="p">}</span>

    <span class="n">template</span> <span class="o">=</span> <span class="n">get_template</span><span class="p">(</span><span class="n">template_name</span><span class="p">)</span>
    <span class="n">html</span> <span class="o">=</span> <span class="n">template</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>

    <span class="c1"># Short-circuit template HTML render into an HttpResponse</span>
    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">template_name</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>

    <span class="c1"># Create a Django response object, specifying content_type as pdf</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="n">content_type</span><span class="o">=</span><span class="s1">&#39;application/pdf&#39;</span><span class="p">)</span>
    <span class="c1"># Display PDF in browser (default)</span>
    <span class="n">response</span><span class="p">[</span><span class="s1">&#39;Content-Disposition&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;filename=&quot;report.pdf&quot;&#39;</span>
    <span class="c1"># Download PDF as file</span>
    <span class="c1">#response[&#39;Content-Disposition&#39;] = &#39;attachment; filename=&quot;report.pdf&quot;&#39;</span>

    <span class="c1"># Generate a PDF from the html template and write it into</span>
    <span class="c1"># the HttpResponse object to pass along to the browser.</span>
    <span class="c1">#pisa_status = pisa.CreatePDF(html, dest=response, link_callback=link_callback)</span>
    <span class="n">pisa_status</span> <span class="o">=</span> <span class="n">pisa</span><span class="o">.</span><span class="n">CreatePDF</span><span class="p">(</span><span class="n">html</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="n">response</span><span class="p">)</span>
    <span class="c1"># If there was an error in PDF generation, return a page with an explanation</span>
    <span class="c1"># A 406 error code means server is unable to return acceptable content per</span>
    <span class="c1"># the clients request. A 500 means an unexpected condition on the server</span>
    <span class="c1"># side prevented the request from being fulfilled (code runtime errors)</span>
    <span class="k">if</span> <span class="n">pisa_status</span><span class="o">.</span><span class="n">err</span><span class="p">:</span>
        <span class="n">message</span> <span class="o">=</span> <span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unable to generate PDF from &lt;hl&gt;&lt;pre&gt;</span><span class="si">{</span><span class="n">html</span><span class="si">}</span><span class="s2">&lt;/pre&gt;&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="mi">500</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">response</span></div>


<div class="viewcode-block" id="index"><a class="viewcode-back" href="../../modules/views.html#polls.views.index">[docs]</a><span class="k">def</span> <span class="nf">index</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;---&gt; Routed to views.index(</span><span class="si">{</span><span class="n">request</span><span class="si">}</span><span class="s2">,</span><span class="si">{</span><span class="n">args</span><span class="si">}</span><span class="s2">,</span><span class="si">{</span><span class="n">kwargs</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;request.GET:</span><span class="si">{</span><span class="n">request</span><span class="o">.</span><span class="n">GET</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="s2">&quot;Hello, world. You&#39;re at the polls index.&quot;</span><span class="p">)</span></div>


<span class="c1"># /polls</span>
<span class="c1"># path(&#39;&#39;, views.home, name=&#39;home&#39;),</span>
<span class="c1"># there are no matched arguments for the home view being</span>
<div class="viewcode-block" id="home"><a class="viewcode-back" href="../../modules/views.html#polls.views.home">[docs]</a><span class="k">def</span> <span class="nf">home</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;---&gt;&quot;</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">)</span>

    <span class="c1"># blocking by returning text from python</span>
    <span class="c1">#questions = Question.objects.order_by(&#39;-pub_date&#39;)[:5]</span>
    <span class="c1">#output = &#39;,&#39;.join([q.question_text for q in questions])</span>
    <span class="c1">#return HttpResponse(output)</span>

    <span class="n">latest_question_list</span> <span class="o">=</span> <span class="n">Question</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s1">&#39;-pub_date&#39;</span><span class="p">)[:</span><span class="mi">5</span><span class="p">]</span>
    <span class="n">context</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;latest_question_list&#39;</span><span class="p">:</span> <span class="n">latest_question_list</span><span class="p">}</span>
    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;polls/home.html&#39;</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span></div>


<span class="c1"># /polls/5/</span>
<span class="c1"># path(&#39;&lt;int:question_id&gt;/&#39;, views.detail, name=&#39;detail&#39;),</span>
<span class="c1"># urls.path(&lt;int:question_id&gt; describes the matched</span>
<span class="c1"># arguments that would be passed to the view</span>
<div class="viewcode-block" id="detail"><a class="viewcode-back" href="../../modules/views.html#polls.views.detail">[docs]</a><span class="k">def</span> <span class="nf">detail</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">question_id</span><span class="p">):</span>
    <span class="n">question</span> <span class="o">=</span> <span class="n">get_object_or_404</span><span class="p">(</span><span class="n">Question</span><span class="p">,</span> <span class="n">pk</span><span class="o">=</span><span class="n">question_id</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;polls/detail.html&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;question&#39;</span><span class="p">:</span> <span class="n">question</span><span class="p">})</span></div>


<span class="c1"># /polls/5/results/</span>
<span class="c1"># path(&#39;&lt;int:question_id&gt;/results/&#39;, views.results, name=&#39;results&#39;),</span>
<div class="viewcode-block" id="results"><a class="viewcode-back" href="../../modules/views.html#polls.views.results">[docs]</a><span class="k">def</span> <span class="nf">results</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">question_id</span><span class="p">):</span>
    <span class="c1"># blocking without DB query</span>
    <span class="c1">#response = &quot;You&#39;re looking at the results of question %s.&quot;</span>
    <span class="c1">#return HttpResponse(response % question_id)</span>

    <span class="n">question</span> <span class="o">=</span> <span class="n">get_object_or_404</span><span class="p">(</span><span class="n">Question</span><span class="p">,</span> <span class="n">pk</span><span class="o">=</span><span class="n">question_id</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;polls/results.html&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;question&#39;</span><span class="p">:</span> <span class="n">question</span><span class="p">})</span></div>




</pre></div>

            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">Django Polls 0.1 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" >Module code</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">polls.views</a></li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2020, Steve Dugaro.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 3.3.1.
    </div>
  </body>
</html>